<!DOCTYPE html>
<html class="deployment-type-development">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <base target="_blank">

    <title>Alternate Publisher Friendlycode Editor</title>
    <link rel="stylesheet" href="{{HTTP_STATIC_URL}}friendlycode/css/friendlycode.css">
    <link rel="stylesheet" href="{{HTTP_STATIC_URL}}button-override.css">
  </head>
  <body style="margin: 0">
    <div id="bare-fc-holder" class="friendlycode-loading"></div>
    <script src="https://login.persona.org/include.js"></script>
    <script src="{{HTTP_STATIC_URL}}friendlycode/js/require-config.js"></script>
    <script src="{{HTTP_STATIC_URL}}friendlycode/vendor/require.min.js"></script>
    <script>
    // Alternate publisher implementation that publishes to a hackpub
    // endpoint. For more information, see:
    // 
    //   https://github.com/hackasaurus/hackpub
    //
    // Note also that the Amazon S3 bucket hackpub publishes to must
    // be configured with a CORS configuration that allows for cross-origin
    // GET requests, e.g.:
    //
    //   <CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/">
    //     <CORSRule>
    //       <AllowedOrigin>*</AllowedOrigin>
    //       <AllowedMethod>GET</AllowedMethod>
    //     </CORSRule>
    //   </CORSConfiguration>

    /**
     * ...
     */
    define("hackpub", ["jquery"], function($) {
      return function Hackpub(options) {
        return {
          loadCode: function(path, cb) {
            var url = path;
            $.ajax({
              type: "GET",
              url: url,
              dataType: 'text',
              error: function(req) {
                cb(req);
              },
              success: function(html) {
                cb(null, html, url);
              }
            });
          },
          saveCode: function(data, originalURL, cb) {

            // fake the originalURL for the moment, based on the current doc. URL
            var originalURL = window.location.toString(),
                iframeDocument = document.querySelectorAll('.preview-holder iframe')[0]
                                         .contentDocument,
                nodeList = iframeDocument.querySelectorAll('meta'),
                metaTags = [],
                title,
                tutorial,
                description;

            if (iframeDocument.title) {
              title = iframeDocument.title;
            }

            if(originalURL.indexOf("/edit")!==-1) {
              originalURL = originalURL.replace('/edit','');
            } else { originalURL = undefined; }

            for (var i = 0; i < nodeList.length; i++) {
              if (nodeList[i].name === 'webmaker-tag') {
                metaTags.push(nodeList[i].content);
              } else if (nodeList[i].name === 'webmaker-description') {
                description = nodeList[i].content;
              } else if (nodeList[i].name === 'webmaker-title' && !title) {
                // We don't want to grab a title if a title element already exists.
                title = nodeList[i].content;
              } else if (nodeList[i].name === 'webmaker-tutorial') {
                tutorial = nodeList[i].content;
              }
            }

            $.ajax({
              type: "POST",
              url: options.hackpubURL + "/publish",
              data: {
                'html': data,
                'original-url': originalURL,
                'metadata': {
                  'tags': metaTags,
                  'title': title,
                  'description': description,
                  'tutorial': tutorial
                }
              },
              dataType: 'json',
              error: function(req) {
                cb(req);
              },
              success: function(result) {
                var url = result['published-url'];
                var path = url.substring(url.lastIndexOf('/')+1);
                cb(null, {path: path, url: options.publishURL + '/' + path});
              }
            });
          }
        };
      };
    });

    /**
     * ...
     */
    define("thimblePage",
           ["jquery", "friendlycode", "hackpub"],
           function($, FriendlycodeEditor, Hackpub) {
      return FriendlycodeEditor({
        allowJS: false,
        defaultContent: '{{template}}',
        pageToLoad: '{{pageToLoad}}',
        publisher: Hackpub({
          hackpubURL: "{{appURL}}",
          publishURL: "{{appURL}}/remix",
        }),
        remixURLTemplate: "{{appURL}}/remix/\{\{VIEW_URL\}\}/edit",
        container: $("#bare-fc-holder")
      });
    });

    /**
     * ...
     */
    require([
      "jquery",
      "thimblePage"
    ], function($, ThimblePage) {
      var personaButton = $("<div>Log In</div>"),
          publishButton = $('.publish-button.wm-button.wm-button-blue.short'),
          navItem = $(".nav-item.buttons"),
          loggedIn = false;
      publishButton.hide();
      personaButton.addClass("persona-button wm-button wm-button-blue short");
      navItem.append(personaButton);
      navigator.id.watch({
        onlogin: function( assertion ) {
          $.ajax({
            type: "POST",
            url: '/persona/verify',
            data: {assertion: assertion},
            success: function(res, status, xhr) {
              loggedIn = true;
              publishButton.show();
              personaButton.text("Log Out");
            },
            error: function(xhr, status, err) {
              navigator.id.logout();
              alert("Login failure: " + err);
            }
          });
        },
        onlogout: function() {
          $.ajax({
            type: 'POST',
            url: '/persona/logout',
            success: function(res, status, xhr) {
              loggedIn = false;
              publishButton.hide();
              personaButton.text("Log In");
            },
            error: function(xhr, status, err) { alert("Logout failure: " + err); }
          });
        }
      });
      personaButton.click(function() {
        if (!loggedIn) {
          navigator.id.request();
        } else {
          navigator.id.logout();
        }
      });
    });
    </script>
  </body>
</html>
