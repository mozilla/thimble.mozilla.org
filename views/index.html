<!DOCTYPE html>
<html class="deployment-type-development">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="persona-email" content="{{email}}">
    <base target="_blank">

    <title>Alternate Publisher Friendlycode Editor</title>
    <link rel="stylesheet" href="{{HTTP_STATIC_URL}}friendlycode/css/friendlycode.css">
    <link rel="stylesheet" href="{{ HTTP_STATIC_URL }}friendlycode-overrides.css">
    <link rel="stylesheet" href="{{HTTP_STATIC_URL}}button-override.css">
    <link rel="stylesheet" href="{{ HTTP_STATIC_URL }}stylesheets/nav.css" />
  </head>
  <body style="margin: 0">

    <!-- webmaker user bar -->
    <link rel="stylesheet" href="{{userbar}}/css/nav.css" />
    <div id="webmaker-nav">
      <nav class="webmaker-nav-container">
        <ul class="webmaker-nav primary">
          <li><a>Webmaker</a></li>
        </ul>
        <ul class="webmaker-nav secondary">
        </ul>
        <ul class="webmaker-nav custom">
        </ul>
        <ul class="webmaker-nav user-info">
          <li class="user">
            <div class="user-name">
              <span id="identity" class="user-name-container"></span>
            </div>
          </li>
          <li>
            <button id="webmaker-login" class="access-button hidden">Login</button>
            <button id="webmaker-logout" class="access-button hidden">Logout</button>
          </li>
        </ul>
      </nav>
    </div>

    <!-- friendcode editor -->
    <div id="bare-fc-holder" class="friendlycode-loading"></div>
    <script src="{{HTTP_STATIC_URL}}friendlycode/js/require-config.js"></script>
    <script src="{{HTTP_STATIC_URL}}friendlycode/vendor/require.min.js"></script>
    <script>
    /**
     * ...
     */
    define("hackpub", ["jquery"], function($) {
      return function Hackpub(options) {
        return {
          loadCode: function(path, cb) {
            var url = path;
            $.ajax({
              type: "GET",
              url: url,
              dataType: 'text',
              error: function(req) {
                cb(req);
              },
              success: function(html) {
                cb(null, html, url);
              }
            });
          },
          saveCode: function(data, originalURL, cb) {

            // fake the originalURL for the moment, based on the current doc. URL
            var originalURL = window.location.toString(),
                iframeDocument = document.querySelector('.preview-holder iframe')
                                         .contentDocument,
                nodeList = Array.prototype.slice.apply(iframeDocument.querySelectorAll('meta')),
                metaData = {
                  tags: []
                },
                metaName,
                metaNames = {
                  'description': function(node) {
                    metaData.description = node.content;
                  },
                  'author': function(node) {
                    metaData.author = node.content;
                  },
                  'webmaker:tags': function(node) {
                    metaData.tags = metaData.tags.concat(node.content.split(","));
                  },
                  'webmaker:thumbnail': function(node) {
                    metaData.thumbnail = node.content;
                  },
                  'webmaker:locale': function(node) {
                    metaData.locale = node.content;
                  },
                  'webmaker:tutorial': function(node) {
                    metaData.tags.push("tutorial:" + node.content);
                  }
                };

            if (iframeDocument.title) {
              metaData.title = iframeDocument.title;
            }

            if(originalURL.indexOf("/edit")!==-1) {
              originalURL = originalURL.replace('/edit','');
            } else { originalURL = undefined; }

            for (var i = 0; i < nodeList.length; i++) {
              metaName = nodeList[i].name;
              if (metaNames[metaName]) {
                metaNames[metaName](nodeList[i]);
              }
            }

            $.ajax({
              type: "POST",
              url: options.hackpubURL + "/publish",
              data: {
                'html': data,
                'original-url': originalURL,
                'metaData': metaData
              },
              dataType: 'json',
              error: function(req) {
                cb(req);
              },
              success: function(result) {
                var url = result['published-url'],
                    path = url.substring(url.lastIndexOf('/')+1);
                cb(null, {path: path, url: url});
              }
            });
          }
        };
      };
    });

    /**
     * ...
     */
    define("thimblePage",
           ["jquery", "friendlycode", "hackpub"],
           function($, FriendlycodeEditor, Hackpub) {
      return FriendlycodeEditor({
        allowJS: false,
        defaultContent: '{{template}}',
        pageToLoad: '{{pageToLoad}}',
        publisher: Hackpub({
          hackpubURL: "{{appURL}}",
          publishURL: "{{appURL}}/remix",
        }),
        remixURLTemplate: "{{appURL}}/remix/\{\{VIEW_URL\}\}/edit",
        container: $("#bare-fc-holder")
      });
    });
    </script>

    <script src="{{audience}}/sso/include.js"></script>

    <script>
    /**
     * ...
     */
    require([
      "jquery",
      "thimblePage"
    ], function($, ThimblePage) {
      var publishButton = $('.publish-button.wm-button.wm-button-blue.short'),
          loggedIn = false;

      publishButton.hide();

      navigator.idSSO.app = {
        onlogin: function(loggedInUser, displayName) {
          publishButton.show();
        },
        onlogout: function() {
          publishButton.hide();
        }
      };
    });
    </script>
    <script src="{{userbar}}/js/sso-ux.js"></script>
  </body>
</html>
